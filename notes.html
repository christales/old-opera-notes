<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Notes</title>
<style type="text/css">
body {font-size: 100%; margin: 1em auto; width: 100%}
select { width: 90%; margin: 1em auto; min-height:12em; display: block; resize: vertical;}
option {font-size: 1.1em}
input[type="button"] {font-weight: 700;display: block; font-size: 2em; position: relative; left: 90%; top: 0}
blockquote {border: 1px solid; min-height: 6em; resize: vertical;
padding: 0; font-size: 1.3em; width: 90%; margin: 0.5em auto;}
p {padding:0; margin-top: 0;}
</style>
</head>
<body>
<input type="button" id="newnote" value="+">
<select id="notelist" onchange="displayNote()" multiple></select>
<blockquote contenteditable="true"></blockquote>

<script type="text/javascript">
// variables
var blocksq = document.getElementsByTagName("blockquote");
var bq = blocksq[0];
var newNote = document.getElementById("newnote");
var noteList = document.getElementById("notelist");
bq.addEventListener("keyup",saveNote,true);
bq.addEventListener("focus",createNote,true);
newNote.addEventListener("click",createNoteByClick,true);
noteList.addEventListener("keydown",deleteNote,true);

//display note
function displayNote() {
var selectedListItem = noteList.options[noteList.selectedIndex];
var e = selectedListItem.value;
var j = selectedListItem.id;
bq.setAttribute("id",e);
bq.innerHTML = localStorage.getItem(j);
}

//delete notes with delete key

function deleteNote(d){
var selectedListItem = noteList.options[noteList.selectedIndex];
if (d.keyCode == 46) {
var j = selectedListItem.value;
var deletedNode = document.getElementById("note-"+j);
localStorage.removeItem("note-"+j);
var sbq = document.getElementById(j);
sbq.innerHTML = "";
sbq.removeAttribute("id");
while (noteList.lastChild) {
   noteList.removeChild(noteList.lastChild);
}
displayListNotes();
}
}



// create a new note, inserting
// a blockquote with an id
// FUTURE plan: if the copied text
// is from a web page, add the 
// URL into the cite attribute 
// [how will this work with localStorage??]


function createNoteByClick() {
var newDate = new Date();
var noteId = newDate.getTime();
bq.setAttribute("id",noteId);
bq.innerHTML = null;
localStorage.setItem("note-"+noteId,"");
bq.focus();
}

function createNote() {
if (bq.hasAttribute("id") == false) {
var newDate = new Date();
var noteId = newDate.getTime();
bq.setAttribute("id",noteId);
localStorage.setItem("note-"+noteId,"");
}
}
//

function saveNote() {
var noteList = document.getElementById("notelist");
prevNoteId = "note-"+bq.id; 
var alreadyThere = document.getElementById(prevNoteId); 
prevNoteText = localStorage.getItem(prevNoteId); 
noteListItem = document.createElement("option");
summaryText = bq.innerHTML;
if (summaryText.length > 25) { 
noteListItem.innerHTML = summaryText.substring(0,25)+"...";
}
else {
noteListItem.innerHTML = summaryText;
}
noteListItem.setAttribute("id",prevNoteId); 
if (alreadyThere) { 
noteList.replaceChild(noteListItem,alreadyThere);
}
else {
noteList.appendChild(noteListItem);
}
localStorage.setItem(prevNoteId,bq.innerHTML);
}


//display list of notes
function displayListNotes(){
var i = 0; 
var noteItems = localStorage.length-1;
for (i = 0; i <= noteItems; i++) { 
var noteKey = localStorage.key(i); 
var noteValue = localStorage.getItem(noteKey); 
var noteTitle;
if(noteValue.length > 25) {
 noteTitle = noteValue.substring(0,25)+"...";
}
else { 
noteTitle = noteValue;
} 
noteListItem = document.createElement("option"); 
noteListItem.innerHTML = noteTitle; 
noteListItem.setAttribute("id",noteKey);
noteListItemValue = noteKey.replace("note-",""); 
noteListItem.setAttribute("value",noteListItemValue);
noteList.appendChild(noteListItem);
}

}
window.onload = displayListNotes();

</script>

</body> 
</html>
